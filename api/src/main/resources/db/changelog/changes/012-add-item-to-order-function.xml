<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.21.xsd">

    <changeSet id="012-add-item-to-order-function" author="dariomatias">
        <sql splitStatements="false" stripComments="false">
            <![CDATA[
            CREATE OR REPLACE FUNCTION add_item_to_order(
                p_order_id UUID,
                p_product_id UUID,
                p_quantity INTEGER,
                p_price NUMERIC
            )
            RETURNS VOID
            LANGUAGE plpgsql
            AS $$
            DECLARE
            v_stock INTEGER;
            BEGIN
            SELECT stock
            INTO v_stock
            FROM products
            WHERE id = p_product_id
              AND active = true
              AND deleted_at IS NULL;

            IF v_stock IS NULL THEN
                    RAISE EXCEPTION 'Produto nÃ£o encontrado ou inativo';
            END IF;

                IF v_stock < p_quantity THEN
                    RAISE EXCEPTION 'Estoque insuficiente';
            END IF;

            INSERT INTO order_items (
                id,
                order_id,
                product_id,
                quantity,
                price,
                created_at
            )
            VALUES (
                       gen_random_uuid(),
                       p_order_id,
                       p_product_id,
                       p_quantity,
                       p_price,
                       now()
                   );

            UPDATE products
            SET stock = stock - p_quantity
            WHERE id = p_product_id;

            END;
            $$;
            ]]>
        </sql>
    </changeSet>

</databaseChangeLog>
